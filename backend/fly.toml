# fly.toml - Backend SUPFile sur Fly.io
# Déploiement : cd backend  puis  fly deploy --app supfile
# Si "app is not listening" : fly deploy --app supfile --no-cache  (force rebuild sans cache)
# Voir https://fly.io/docs/reference/configuration/
#
# Secrets OBLIGATOIRES (fly secrets set) avant que connexion/inscription fonctionnent :
#   fly secrets set MONGO_URI="[REDACTED]"
#   fly secrets set JWT_SECRET="[REDACTED]"
#   fly secrets set JWT_REFRESH_SECRET="[REDACTED]"
#   fly secrets set SESSION_SECRET="[REDACTED]"
# Optionnel : CORS_ORIGIN si frontend sur une autre origine (ex: http://localhost:5173)
#

app = 'supfile'
primary_region = 'cdg'

[env]
  PORT = "5000"
  NODE_ENV = "production"
  # Même chemin que le volume monté : les file_path en base pointent vers des fichiers accessibles (ZIP, téléchargement)
  UPLOAD_DIR = "/usr/src/app/uploads"

[build]

[http_service]
  internal_port = 5000
  force_https = true
  auto_stop_machines = 'stop'
  auto_start_machines = true
  min_machines_running = 1
  processes = ['app']

  [[http_service.checks]]
    grace_period = "60s"
    interval = "10s"
    method = "GET"
    timeout = "10s"
    path = "/health"

[[vm]]
  memory = '1gb'
  cpus = 1
  memory_mb = 1024

[[mounts]]
  source = "uploads_data"
  destination = "/usr/src/app/uploads"
